name: n8n Workflow Development Tracker

on:
  push:
    branches: [ main, feature/* ]
    paths:
      - '**/*.json'
      - '**/*.md'
      - '.kiro/specs/**'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      task_name:
        description: 'Task name to track'
        required: true
        type: string
      task_status:
        description: 'Task status'
        required: true
        type: choice
        options:
          - started
          - in-progress
          - completed
          - blocked

jobs:
  track-workflow-development:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install dependencies
      run: |
        npm install -g jq
        npm install -g @anthropic/claude-code

    # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æ¤œè¨¼
    - name: Validate n8n Workflow JSON
      run: |
        echo "ðŸ” Validating workflow JSON..."
        for file in projects/**/*.json; do
          if [ -f "$file" ]; then
            echo "Checking: $file"
            jq empty "$file" || exit 1
            
            # n8nå¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒã‚§ãƒƒã‚¯
            jq -e '.name and .nodes and .connections' "$file" || {
              echo "âŒ Missing required n8n fields in $file"
              exit 1
            }
          fi
        done
        echo "âœ… All JSON files are valid"

    # ãƒŽãƒ¼ãƒ‰æ•°ã¨é€²æ—ã®è¿½è·¡
    - name: Track Workflow Progress
      run: |
        WORKFLOW_FILE="projects/c-suite-outreach-automation/c-suite-outreach-automation.json"
        if [ -f "$WORKFLOW_FILE" ]; then
          NODE_COUNT=$(jq '.nodes | length' "$WORKFLOW_FILE")
          echo "ðŸ“Š Current node count: $NODE_COUNT"
          
          # é€²æ—ãƒ¬ãƒãƒ¼ãƒˆã®ç”Ÿæˆ
          cat > progress-report.md << EOF
        # Workflow Development Progress Report
        
        ## Stats
        - **Total Nodes**: $NODE_COUNT
        - **Timestamp**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        - **Branch**: ${{ github.ref_name }}
        - **Commit**: ${{ github.sha }}
        
        ## Node Types Distribution
        $(jq -r '.nodes | group_by(.type) | map({type: .[0].type, count: length}) | .[] | "- \(.type): \(.count)"' "$WORKFLOW_FILE")
        
        ## Implemented Features
        $(jq -r '.nodes | map(.name) | .[] | "- [x] \(.)"' "$WORKFLOW_FILE" | head -20)
        EOF
        fi

    # Git diffã‹ã‚‰å¤‰æ›´å†…å®¹ã‚’æŠ½å‡º
    - name: Extract Changes
      if: github.event_name == 'push'
      run: |
        echo "ðŸ“ Changes in this commit:"
        git diff --name-status HEAD~1 HEAD | grep -E '\.(json|md)$' || true
        
        # è¿½åŠ ã•ã‚ŒãŸãƒŽãƒ¼ãƒ‰ã‚’æ¤œå‡º
        if [ -f "projects/c-suite-outreach-automation/c-suite-outreach-automation.json" ]; then
          git diff HEAD~1 HEAD -- "projects/c-suite-outreach-automation/c-suite-outreach-automation.json" | \
          grep '^+.*"name":' | sed 's/.*"name": "\(.*\)".*/- Added node: \1/' || true
        fi

    # ã‚¿ã‚¹ã‚¯å®Œäº†çŠ¶æ³ã®è¨˜éŒ²
    - name: Record Task Completion
      if: github.event_name == 'workflow_dispatch'
      run: |
        TASK_NAME="${{ github.event.inputs.task_name }}"
        TASK_STATUS="${{ github.event.inputs.task_status }}"
        TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
        
        # ã‚¿ã‚¹ã‚¯ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã«è¿½è¨˜
        mkdir -p .github/workflow-logs
        echo "[$TIMESTAMP] Task: $TASK_NAME - Status: $TASK_STATUS" >> .github/workflow-logs/task-history.log
        
        # ã‚¿ã‚¹ã‚¯ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’JSONã§ä¿å­˜
        cat > .github/workflow-logs/current-task.json << EOF
        {
          "task": "$TASK_NAME",
          "status": "$TASK_STATUS",
          "timestamp": "$TIMESTAMP",
          "commit": "${{ github.sha }}",
          "actor": "${{ github.actor }}"
        }
        EOF

    # Claude AIã¨ã®å¯¾è©±ãƒ­ã‚°ã‚’ä¿å­˜
    - name: Save Development Conversation
      if: github.event_name == 'push'
      run: |
        # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰é–‹ç™ºå†…å®¹ã‚’æŠ½å‡º
        COMMIT_MSG=$(git log -1 --pretty=%B)
        
        # é–‹ç™ºãƒ­ã‚°ã«è¿½è¨˜
        cat >> .github/workflow-logs/development-log.md << EOF
        
        ## $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        
        ### Commit: ${{ github.sha }}
        **Message**: $COMMIT_MSG
        
        ### Changes:
        $(git diff --stat HEAD~1 HEAD)
        
        ---
        EOF

    # é€²æ—ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜
    - name: Upload Progress Report
      uses: actions/upload-artifact@v3
      with:
        name: workflow-progress-${{ github.run_number }}
        path: |
          progress-report.md
          .github/workflow-logs/

    # PRã‚³ãƒ¡ãƒ³ãƒˆã«é€²æ—ã‚’æŠ•ç¨¿
    - name: Comment PR with Progress
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('progress-report.md', 'utf8');
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: report
          });

    # Slackã¸ã®é€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    - name: Notify Progress
      if: env.SLACK_WEBHOOK_URL != ''
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        NODE_COUNT=$(jq '.nodes | length' "projects/c-suite-outreach-automation/c-suite-outreach-automation.json" 2>/dev/null || echo "0")
        curl -X POST $SLACK_WEBHOOK_URL \
          -H 'Content-type: application/json' \
          -d "{
            \"text\": \"n8n Workflow Update\",
            \"blocks\": [{
              \"type\": \"section\",
              \"text\": {
                \"type\": \"mrkdwn\",
                \"text\": \"*Workflow Development Update*\nâ€¢ Nodes: $NODE_COUNT\nâ€¢ Branch: ${{ github.ref_name }}\nâ€¢ Actor: ${{ github.actor }}\"
              }
            }]
          }"