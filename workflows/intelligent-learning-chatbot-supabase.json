{
  "name": "Intelligent Learning Chatbot - Supabase Edition",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "chatbot",
        "responseMode": "responseNode",
        "options": {
          "responseCode": 200,
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          }
        }
      },
      "id": "webhook-trigger",
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [260, 340],
      "webhookId": "chatbot-webhook"
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{$json.message}}",
              "operation": "isNotEmpty"
            }
          ]
        }
      },
      "id": "input-validation",
      "name": "Input Validation",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [480, 340]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "session-id",
              "name": "sessionId",
              "value": "={{$json.sessionId || $uuid()}}",
              "type": "string"
            },
            {
              "id": "user-message",
              "name": "userMessage",
              "value": "={{$json.message}}",
              "type": "string"
            },
            {
              "id": "user-id",
              "name": "userId",
              "value": "={{$json.userId || 'anonymous'}}",
              "type": "string"
            },
            {
              "id": "timestamp",
              "name": "timestamp",
              "value": "={{$now.toISO()}}",
              "type": "string"
            },
            {
              "id": "enable-feedback",
              "name": "enableFeedback",
              "value": "={{$json.enableFeedback !== false}}",
              "type": "boolean"
            },
            {
              "id": "enable-rag",
              "name": "enableRAG",
              "value": "={{$json.enableRAG !== false}}",
              "type": "boolean"
            }
          ]
        },
        "options": {}
      },
      "id": "extract-session",
      "name": "Extract Session Info",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [700, 260]
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "sessions",
        "filterType": "string",
        "filters": {
          "conditions": [
            {
              "field": "id",
              "condition": "eq",
              "value": "={{$json.sessionId}}"
            },
            {
              "field": "is_active",
              "condition": "eq",
              "value": "true"
            }
          ]
        },
        "options": {
          "select": "*",
          "limit": 1
        }
      },
      "id": "check-session",
      "name": "Check Session",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [920, 260],
      "credentials": {
        "supabaseApi": {
          "id": "supabase-credentials",
          "name": "Supabase account"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{$json.length}}",
              "operation": "larger",
              "value2": 0
            }
          ]
        },
        "options": {}
      },
      "id": "session-exists",
      "name": "Session Exists?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1140, 260]
    },
    {
      "parameters": {
        "operation": "create",
        "tableId": "sessions",
        "dataToSend": "defineBelow",
        "fieldsToSend": {
          "values": [
            {
              "field": "id",
              "fieldValue": "={{$('Extract Session Info').item.json.sessionId}}"
            },
            {
              "field": "user_id",
              "fieldValue": "={{$('Extract Session Info').item.json.userId}}"
            },
            {
              "field": "started_at",
              "fieldValue": "={{$now.toISO()}}"
            },
            {
              "field": "last_activity",
              "fieldValue": "={{$now.toISO()}}"
            },
            {
              "field": "is_active",
              "fieldValue": "=true"
            }
          ]
        }
      },
      "id": "create-session",
      "name": "Create New Session",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [1360, 380],
      "credentials": {
        "supabaseApi": {
          "id": "supabase-credentials",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "sessions",
        "filterType": "string",
        "filters": {
          "conditions": [
            {
              "field": "id",
              "condition": "eq",
              "value": "={{$json[0].id}}"
            }
          ]
        },
        "dataToSend": "defineBelow",
        "fieldsToSend": {
          "values": [
            {
              "field": "last_activity",
              "fieldValue": "={{$now.toISO()}}"
            }
          ]
        }
      },
      "id": "update-session",
      "name": "Update Session Activity",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [1360, 140],
      "credentials": {
        "supabaseApi": {
          "id": "supabase-credentials",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "mode": "combine",
        "combinationMode": "mergeByPosition",
        "options": {}
      },
      "id": "merge-session",
      "name": "Merge Session Data",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2.1,
      "position": [1580, 260]
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "conversations",
        "filterType": "string",
        "filters": {
          "conditions": [
            {
              "field": "session_id",
              "condition": "eq",
              "value": "={{$('Extract Session Info').item.json.sessionId}}"
            }
          ]
        },
        "options": {
          "select": "id,user_message,ai_response,created_at",
          "order": "created_at.desc",
          "limit": 10
        }
      },
      "id": "load-history",
      "name": "Load Conversation History",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [1800, 140],
      "credentials": {
        "supabaseApi": {
          "id": "supabase-credentials",
          "name": "Supabase account"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{$('Extract Session Info').item.json.userMessage}}",
        "hasOutputParser": false,
        "options": {
          "systemMessage": "ã‚ãªãŸã¯è¦ªåˆ‡ã§çŸ¥è­˜è±Šå¯ŒãªAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚\n\n## é‡è¦ãªæŒ‡ç¤º:\n- ä¼šè©±å±¥æ­´ã‚’å‚è€ƒã«ã—ã¦ä¸€è²«æ€§ã®ã‚ã‚‹å¿œç­”ã‚’æä¾›ã™ã‚‹\n- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä»¥å‰æä¾›ã—ãŸæƒ…å ±ã‚’è¦šãˆã¦æ´»ç”¨ã™ã‚‹\n- è‡ªç„¶ã§è¦ªã—ã¿ã‚„ã™ã„å£èª¿ã‚’ä¿ã¤\n- ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‹ã‚‰å­¦ç¿’ã—ãŸæ”¹å–„ã‚’é©ç”¨ã™ã‚‹\n- ç°¡æ½”ã§åˆ†ã‹ã‚Šã‚„ã™ã„èª¬æ˜ã‚’å¿ƒãŒã‘ã‚‹\n\n## ä¼šè©±å±¥æ­´:\n{{$('Load Conversation History').all().map(c => `User: ${c.json.user_message}\\nAI: ${c.json.ai_response}`).join('\\n\\n')}}\n\n## ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±:\n- ã‚»ãƒƒã‚·ãƒ§ãƒ³ID: {{$('Extract Session Info').item.json.sessionId}}\n- ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: {{$('Extract Session Info').item.json.userId}}",
          "maxIterations": 10,
          "returnIntermediateSteps": false
        }
      },
      "id": "ai-agent",
      "name": "AI Agent",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [2020, 260]
    },
    {
      "parameters": {
        "model": "gpt-3.5-turbo",
        "options": {
          "temperature": 0.7,
          "maxTokensToSample": 1000,
          "topP": 0.9,
          "frequencyPenalty": 0.3,
          "presencePenalty": 0.3
        }
      },
      "id": "openai-model",
      "name": "OpenAI Chat Model",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [2020, 660],
      "credentials": {
        "openAiApi": {
          "id": "openai-credentials",
          "name": "OpenAI API"
        }
      }
    },
    {
      "parameters": {
        "operation": "create",
        "tableId": "conversations",
        "dataToSend": "defineBelow",
        "fieldsToSend": {
          "values": [
            {
              "field": "session_id",
              "fieldValue": "={{$('Extract Session Info').item.json.sessionId}}"
            },
            {
              "field": "user_message",
              "fieldValue": "={{$('Extract Session Info').item.json.userMessage}}"
            },
            {
              "field": "ai_response",
              "fieldValue": "={{$('AI Agent').item.json.output}}"
            },
            {
              "field": "user_id",
              "fieldValue": "={{$('Extract Session Info').item.json.userId}}"
            },
            {
              "field": "context_type",
              "fieldValue": "general"
            },
            {
              "field": "metadata",
              "fieldValue": "={{JSON.stringify({timestamp: $now.toISO(), ragEnabled: $('Extract Session Info').item.json.enableRAG})}}"
            }
          ]
        },
        "options": {
          "returnFields": "id,created_at"
        }
      },
      "id": "save-conversation",
      "name": "Save Conversation",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [2460, 260],
      "credentials": {
        "supabaseApi": {
          "id": "supabase-credentials",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "response",
              "name": "response",
              "value": "={{$('AI Agent').item.json.output}}",
              "type": "string"
            },
            {
              "id": "session-id",
              "name": "sessionId",
              "value": "={{$('Extract Session Info').item.json.sessionId}}",
              "type": "string"
            },
            {
              "id": "conversation-id",
              "name": "conversationId",
              "value": "={{$json.id}}",
              "type": "string"
            },
            {
              "id": "timestamp",
              "name": "timestamp",
              "value": "={{$json.created_at}}",
              "type": "string"
            },
            {
              "id": "status",
              "name": "status",
              "value": "success",
              "type": "string"
            },
            {
              "id": "feedback-enabled",
              "name": "feedbackEnabled",
              "value": "={{$('Extract Session Info').item.json.enableFeedback}}",
              "type": "boolean"
            },
            {
              "id": "feedback-url",
              "name": "feedbackUrl",
              "value": "={{$('Extract Session Info').item.json.enableFeedback ? '/webhook/chatbot/feedback' : null}}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "format-response",
      "name": "Format Response",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [2680, 260]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "respond-webhook",
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [2900, 260]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "chatbot/feedback",
        "responseMode": "responseNode",
        "options": {
          "responseCode": 200,
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          }
        }
      },
      "id": "feedback-webhook",
      "name": "Feedback Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [260, 700],
      "webhookId": "chatbot-feedback-webhook"
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{$json.sessionId}}",
              "operation": "isNotEmpty"
            },
            {
              "value1": "={{$json.conversationId}}",
              "operation": "isNotEmpty"
            }
          ]
        }
      },
      "id": "validate-feedback",
      "name": "Validate Feedback",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [480, 700]
    },
    {
      "parameters": {
        "operation": "create",
        "tableId": "feedback",
        "dataToSend": "defineBelow",
        "fieldsToSend": {
          "values": [
            {
              "field": "conversation_id",
              "fieldValue": "={{$json.conversationId}}"
            },
            {
              "field": "session_id",
              "fieldValue": "={{$json.sessionId}}"
            },
            {
              "field": "rating",
              "fieldValue": "={{$json.rating}}"
            },
            {
              "field": "is_helpful",
              "fieldValue": "={{$json.isHelpful}}"
            },
            {
              "field": "feedback_text",
              "fieldValue": "={{$json.feedbackText || ''}}"
            },
            {
              "field": "feedback_type",
              "fieldValue": "={{$json.feedbackType || 'general'}}"
            }
          ]
        },
        "options": {
          "returnFields": "id,created_at"
        }
      },
      "id": "save-feedback",
      "name": "Save Feedback",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [700, 620],
      "credentials": {
        "supabaseApi": {
          "id": "supabase-credentials",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{$json.improvedResponse}}",
              "operation": "isNotEmpty"
            }
          ]
        }
      },
      "id": "has-improvement",
      "name": "Has Improvement?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [920, 620]
    },
    {
      "parameters": {
        "operation": "create",
        "tableId": "learning_improvements",
        "dataToSend": "defineBelow",
        "fieldsToSend": {
          "values": [
            {
              "field": "feedback_id",
              "fieldValue": "={{$('Save Feedback').item.json.id}}"
            },
            {
              "field": "original_response",
              "fieldValue": "={{$json.originalResponse}}"
            },
            {
              "field": "improved_response",
              "fieldValue": "={{$json.improvedResponse}}"
            },
            {
              "field": "improvement_type",
              "fieldValue": "user_correction"
            },
            {
              "field": "applied",
              "fieldValue": "=false"
            }
          ]
        }
      },
      "id": "save-improvement",
      "name": "Save Improvement",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [1140, 540],
      "credentials": {
        "supabaseApi": {
          "id": "supabase-credentials",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "message",
              "name": "message",
              "value": "ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸ",
              "type": "string"
            },
            {
              "id": "feedback-id",
              "name": "feedbackId",
              "value": "={{$('Save Feedback').item.json.id}}",
              "type": "string"
            },
            {
              "id": "improvement-saved",
              "name": "improvementSaved",
              "value": "={{$('Save Improvement').item.json ? true : false}}",
              "type": "boolean"
            },
            {
              "id": "status",
              "name": "status",
              "value": "success",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "format-feedback-response",
      "name": "Format Feedback Response",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [1360, 620]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "respond-feedback",
      "name": "Respond to Feedback",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1580, 620]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "chatbot/knowledge/add",
        "responseMode": "responseNode",
        "options": {
          "responseCode": 200,
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          }
        }
      },
      "id": "add-knowledge-webhook",
      "name": "Add Knowledge Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [260, 900],
      "webhookId": "add-knowledge-webhook"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "title",
              "name": "title",
              "value": "={{$json.title}}",
              "type": "string"
            },
            {
              "id": "content",
              "name": "content",
              "value": "={{$json.content}}",
              "type": "string"
            },
            {
              "id": "category",
              "name": "category",
              "value": "={{$json.category || 'general'}}",
              "type": "string"
            },
            {
              "id": "source",
              "name": "source",
              "value": "={{$json.source || 'manual'}}",
              "type": "string"
            },
            {
              "id": "pageContent",
              "name": "pageContent",
              "value": "={{$json.title + '\\n\\n' + $json.content}}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "prepare-document",
      "name": "Prepare Document",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [480, 900]
    },
    {
      "parameters": {
        "dataType": "json",
        "value1": "={{JSON.stringify({pageContent: $json.pageContent, metadata: {title: $json.title, category: $json.category, source: $json.source}})}}",
        "options": {}
      },
      "id": "json-document",
      "name": "Create JSON Document",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [700, 900]
    },
    {
      "parameters": {
        "operation": "create",
        "tableId": "knowledge_base",
        "dataToSend": "defineBelow",
        "fieldsToSend": {
          "values": [
            {
              "field": "title",
              "fieldValue": "={{$('Prepare Document').item.json.title}}"
            },
            {
              "field": "content",
              "fieldValue": "={{$('Prepare Document').item.json.content}}"
            },
            {
              "field": "category",
              "fieldValue": "={{$('Prepare Document').item.json.category}}"
            },
            {
              "field": "tags",
              "fieldValue": "={{[$('Prepare Document').item.json.category]}}"
            },
            {
              "field": "source_url",
              "fieldValue": "={{$('Prepare Document').item.json.source}}"
            }
          ]
        },
        "options": {
          "returnFields": "id,title,created_at"
        }
      },
      "id": "save-to-knowledge-base",
      "name": "Save to Knowledge Base",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [920, 900],
      "credentials": {
        "supabaseApi": {
          "id": "supabase-credentials",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "message",
              "name": "message",
              "value": "ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹ã«è¿½åŠ ã—ã¾ã—ãŸ",
              "type": "string"
            },
            {
              "id": "knowledge-id",
              "name": "knowledgeId",
              "value": "={{$json.id}}",
              "type": "string"
            },
            {
              "id": "title",
              "name": "title",
              "value": "={{$json.title}}",
              "type": "string"
            },
            {
              "id": "created-at",
              "name": "createdAt",
              "value": "={{$json.created_at}}",
              "type": "string"
            },
            {
              "id": "status",
              "name": "status",
              "value": "success",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "knowledge-response",
      "name": "Knowledge Response",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [1140, 900]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "respond-knowledge",
      "name": "Respond to Knowledge",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1360, 900]
    },
    {
      "parameters": {
        "content": "## ğŸ“š ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹ç®¡ç†ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ\n\nã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯ç‹¬ç«‹ã—ãŸãƒŠãƒ¬ãƒƒã‚¸ç®¡ç†ç”¨ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§ã™ã€‚\n\n### ä½¿ç”¨æ–¹æ³•:\n```json\nPOST /webhook/chatbot/knowledge/add\n{\n  \"title\": \"ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã‚¿ã‚¤ãƒˆãƒ«\",\n  \"content\": \"ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å†…å®¹\",\n  \"category\": \"ã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼ˆçœç•¥å¯ï¼‰\",\n  \"source\": \"ã‚½ãƒ¼ã‚¹æƒ…å ±ï¼ˆçœç•¥å¯ï¼‰\"\n}\n```\n\n### å‡¦ç†ãƒ•ãƒ­ãƒ¼:\n1. Webhookã§ãƒ‡ãƒ¼ã‚¿å—ä¿¡\n2. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™\n3. Supabaseã®knowledge_baseãƒ†ãƒ¼ãƒ–ãƒ«ã«ä¿å­˜\n4. ä¿å­˜ã—ãŸãƒ‡ãƒ¼ã‚¿ã¯è‡ªå‹•çš„ã«Vector Storeã§æ¤œç´¢å¯èƒ½ã«ãªã‚‹\n\n### æ³¨æ„:\n- Vector embeddingsã¯åˆ¥é€”ãƒãƒƒãƒå‡¦ç†ã§ç”Ÿæˆã•ã‚Œã‚‹\n- ãƒ¡ã‚¤ãƒ³ã®ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¨ã¯ç‹¬ç«‹ã—ã¦å‹•ä½œ",
        "height": 400,
        "width": 350
      },
      "id": "knowledge-sticky-note",
      "name": "Knowledge Management Note",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [220, 1080]
    },
    {
      "parameters": {
        "content": "## ğŸ¤– AI Agentã«ã¤ã„ã¦\n\nç¾åœ¨ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§ã¯AI Agentã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚\n\n### AI Agentã®ç‰¹å¾´:\n- ä¼šè©±å±¥æ­´ã®ç®¡ç†\n- ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã®æ´»ç”¨\n- æŸ”è»Ÿãªå¿œç­”ç”Ÿæˆ\n\n### RAGæ©Ÿèƒ½ã«ã¤ã„ã¦:\nç¾åœ¨ã€Vector Storeæ¤œç´¢ã¯å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nRAGæ©Ÿèƒ½ãŒå¿…è¦ãªå ´åˆã¯ä»¥ä¸‹ã®é¸æŠè‚¢ãŒã‚ã‚Šã¾ã™ï¼š\n\n1. **RetrievalQA Chain**ã‚’ä½¿ç”¨ï¼ˆAI Agentã‚’ç½®ãæ›ãˆï¼‰\n2. **ã‚«ã‚¹ã‚¿ãƒ ãƒ„ãƒ¼ãƒ«**ã‚’ä½œæˆã—ã¦AI Agentã«æ¥ç¶š\n3. **åˆ¥ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**ã§Vectoræ¤œç´¢ã‚’å®Ÿè£…\n\n### ç¾åœ¨ã®å®Ÿè£…:\n- ä¼šè©±å±¥æ­´ã¯Supabaseã«ä¿å­˜\n- ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹ã¸ã®è¿½åŠ ã¯å¯èƒ½\n- ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã¯æœªå®Ÿè£…",
        "height": 350,
        "width": 400
      },
      "id": "ai-agent-note",
      "name": "AI Agent Note",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [2420, 200]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "error-message",
              "name": "error",
              "value": "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒç©ºã§ã™ã€‚'message'ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚",
              "type": "string"
            },
            {
              "id": "error-status",
              "name": "status",
              "value": "error",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "validation-error",
      "name": "Validation Error",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [700, 420]
    },
    {
      "parameters": {
        "options": {
          "responseCode": 400
        }
      },
      "id": "validation-error-response",
      "name": "Validation Error Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [920, 420]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "error-message",
              "name": "error",
              "value": "ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã®æ¤œè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚",
              "type": "string"
            },
            {
              "id": "error-status",
              "name": "status",
              "value": "error",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "feedback-validation-error",
      "name": "Feedback Validation Error",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [700, 780]
    },
    {
      "parameters": {
        "options": {
          "responseCode": 400
        }
      },
      "id": "feedback-error-response",
      "name": "Feedback Error Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [920, 780]
    }
  ],
  "connections": {
    "Webhook Trigger": {
      "main": [
        [
          {
            "node": "Input Validation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Input Validation": {
      "main": [
        [
          {
            "node": "Extract Session Info",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Validation Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Session Info": {
      "main": [
        [
          {
            "node": "Check Session",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Session": {
      "main": [
        [
          {
            "node": "Session Exists?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Session Exists?": {
      "main": [
        [
          {
            "node": "Update Session Activity",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Create New Session",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Session Activity": {
      "main": [
        [
          {
            "node": "Merge Session Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create New Session": {
      "main": [
        [
          {
            "node": "Merge Session Data",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge Session Data": {
      "main": [
        [
          {
            "node": "Load Conversation History",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Load Conversation History": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Save Conversation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Save Conversation": {
      "main": [
        [
          {
            "node": "Format Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Response": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Feedback Webhook": {
      "main": [
        [
          {
            "node": "Validate Feedback",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate Feedback": {
      "main": [
        [
          {
            "node": "Save Feedback",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Feedback Validation Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Feedback": {
      "main": [
        [
          {
            "node": "Has Improvement?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has Improvement?": {
      "main": [
        [
          {
            "node": "Save Improvement",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Format Feedback Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Improvement": {
      "main": [
        [
          {
            "node": "Format Feedback Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Feedback Response": {
      "main": [
        [
          {
            "node": "Respond to Feedback",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Add Knowledge Webhook": {
      "main": [
        [
          {
            "node": "Prepare Document",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Document": {
      "main": [
        [
          {
            "node": "Create JSON Document",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create JSON Document": {
      "main": [
        [
          {
            "node": "Save to Knowledge Base",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save to Knowledge Base": {
      "main": [
        [
          {
            "node": "Knowledge Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Knowledge Response": {
      "main": [
        [
          {
            "node": "Respond to Knowledge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validation Error": {
      "main": [
        [
          {
            "node": "Validation Error Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Feedback Validation Error": {
      "main": [
        [
          {
            "node": "Feedback Error Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "saveExecutionProgress": true,
    "saveDataSuccessExecution": "all",
    "saveDataErrorExecution": "all",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": "",
    "timezone": "Asia/Tokyo"
  },
  "versionId": "supabase-rag-edition",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "intelligent-learning-chatbot-supabase",
    "description": "Intelligent learning chatbot with Supabase integration, Vector Store RAG, and feedback system"
  },
  "id": "intelligent-learning-chatbot-supabase",
  "tags": [
    {
      "id": "chatbot",
      "name": "Chatbot"
    },
    {
      "id": "ai",
      "name": "AI"
    },
    {
      "id": "supabase",
      "name": "Supabase"
    },
    {
      "id": "rag",
      "name": "RAG"
    },
    {
      "id": "vector",
      "name": "Vector"
    }
  ]
}