{
  "name": "Intelligent Learning Chatbot - Phase 4 (RAG Implementation)",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "chatbot/rag",
        "responseMode": "responseNode",
        "options": {
          "responseCode": 200,
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          }
        }
      },
      "id": "webhook-trigger",
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [260, 340],
      "webhookId": "chatbot-rag-webhook"
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{$json.message}}",
              "operation": "isNotEmpty"
            }
          ]
        }
      },
      "id": "input-validation",
      "name": "Input Validation",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [480, 340]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "query",
              "name": "query",
              "value": "={{$json.message}}",
              "type": "string"
            },
            {
              "id": "session-id",
              "name": "sessionId",
              "value": "={{$json.sessionId || $uuid()}}",
              "type": "string"
            },
            {
              "id": "user-id",
              "name": "userId",
              "value": "={{$json.userId || 'anonymous'}}",
              "type": "string"
            },
            {
              "id": "timestamp",
              "name": "timestamp",
              "value": "={{$now.toISO()}}",
              "type": "string"
            },
            {
              "id": "search-threshold",
              "name": "searchThreshold",
              "value": "={{$json.threshold || 0.7}}",
              "type": "number"
            },
            {
              "id": "top-k",
              "name": "topK",
              "value": "={{$json.topK || 5}}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "id": "extract-query",
      "name": "Extract Query",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [700, 260]
    },
    {
      "parameters": {
        "model": "text-embedding-3-small",
        "text": "={{$json.query}}",
        "options": {}
      },
      "id": "generate-embedding",
      "name": "Generate Embedding",
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1,
      "position": [920, 260],
      "credentials": {
        "openAiApi": {
          "id": "openai-credentials",
          "name": "OpenAI API"
        }
      }
    },
    {
      "parameters": {
        "collection": "knowledge_base",
        "prompt": "={{$('Extract Query').item.json.query}}",
        "topK": "={{$('Extract Query').item.json.topK}}"
      },
      "id": "vector-store-retriever",
      "name": "Vector Store Retriever",
      "type": "@n8n/n8n-nodes-langchain.vectorStoreRetriever",
      "typeVersion": 1,
      "position": [1140, 380]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "rag-context",
              "name": "ragContext",
              "value": "={{$json.documents ? $json.documents.map(doc => doc.pageContent).join('\\n\\n---\\n\\n') : ''}}",
              "type": "string"
            },
            {
              "id": "query",
              "name": "query",
              "value": "={{$('Extract Query').item.json.query}}",
              "type": "string"
            },
            {
              "id": "session-id",
              "name": "sessionId",
              "value": "={{$('Extract Query').item.json.sessionId}}",
              "type": "string"
            },
            {
              "id": "user-id",
              "name": "userId",
              "value": "={{$('Extract Query').item.json.userId}}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "build-context",
      "name": "Build RAG Context",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [1360, 260]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "ä»¥ä¸‹ã®å‚è€ƒæƒ…å ±ã‚’åŸºã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã«ç­”ãˆã¦ãã ã•ã„ã€‚\n\n## å‚è€ƒæƒ…å ±:\n{{$json.ragContext}}\n\n## ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•:\n{{$json.query}}\n\n## å›ç­”æŒ‡ç¤º:\n- å‚è€ƒæƒ…å ±ã‚’æ´»ç”¨ã—ã¦å…·ä½“çš„ã«å›ç­”\n- å‚è€ƒæƒ…å ±ã«ãªã„å ´åˆã¯ä¸€èˆ¬çš„ãªçŸ¥è­˜ã§è£œå®Œ\n- ç°¡æ½”ã§åˆ†ã‹ã‚Šã‚„ã™ã„èª¬æ˜ã‚’å¿ƒãŒã‘ã‚‹",
        "hasOutputParser": false,
        "options": {
          "systemMessage": "ã‚ãªãŸã¯çŸ¥è­˜è±Šå¯ŒãªAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚æä¾›ã•ã‚ŒãŸå‚è€ƒæƒ…å ±ã‚’æ´»ç”¨ã—ã¦ã€æ­£ç¢ºã§å½¹ç«‹ã¤å›ç­”ã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚",
          "maxIterations": 5,
          "returnIntermediateSteps": false
        }
      },
      "id": "ai-agent",
      "name": "AI Agent with RAG",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [1580, 260]
    },
    {
      "parameters": {
        "model": "gpt-3.5-turbo",
        "options": {
          "temperature": 0.5,
          "maxTokensToSample": 1500,
          "topP": 0.9
        }
      },
      "id": "openai-model",
      "name": "OpenAI Chat Model",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [1580, 420],
      "credentials": {
        "openAiApi": {
          "id": "openai-credentials",
          "name": "OpenAI API"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{$('Extract Query').item.json.sessionId}}",
        "windowSize": 10
      },
      "id": "memory-buffer",
      "name": "Memory Buffer",
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.2,
      "position": [1580, 540]
    },
    {
      "parameters": {
        "supabaseProjectUrl": "={{$env.SUPABASE_URL}}",
        "tableName": "knowledge_base",
        "queryName": "match_documents",
        "options": {}
      },
      "id": "vector-store-supabase",
      "name": "Supabase Vector Store",
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1,
      "position": [1140, 500],
      "credentials": {
        "supabaseApi": {
          "id": "supabase-credentials",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "operation": "create",
        "tableId": "conversations",
        "dataToSend": "defineBelow",
        "fieldsToSend": {
          "values": [
            {
              "field": "session_id",
              "fieldValue": "={{$('Build RAG Context').item.json.sessionId}}"
            },
            {
              "field": "user_message",
              "fieldValue": "={{$('Build RAG Context').item.json.query}}"
            },
            {
              "field": "ai_response",
              "fieldValue": "={{$json.output}}"
            },
            {
              "field": "user_id",
              "fieldValue": "={{$('Build RAG Context').item.json.userId}}"
            },
            {
              "field": "context_type",
              "fieldValue": "rag"
            },
            {
              "field": "metadata",
              "fieldValue": "={{JSON.stringify({ragContext: $('Build RAG Context').item.json.ragContext.substring(0, 500)})}}"
            }
          ]
        },
        "options": {
          "returnFields": "id,created_at"
        }
      },
      "id": "save-conversation",
      "name": "Save Conversation",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [1800, 260],
      "credentials": {
        "supabaseApi": {
          "id": "supabase-credentials",
          "name": "Supabase account"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "response",
              "name": "response",
              "value": "={{$('AI Agent with RAG').item.json.output}}",
              "type": "string"
            },
            {
              "id": "session-id",
              "name": "sessionId",
              "value": "={{$('Build RAG Context').item.json.sessionId}}",
              "type": "string"
            },
            {
              "id": "conversation-id",
              "name": "conversationId",
              "value": "={{$json.id}}",
              "type": "string"
            },
            {
              "id": "rag-used",
              "name": "ragUsed",
              "value": true,
              "type": "boolean"
            },
            {
              "id": "status",
              "name": "status",
              "value": "success",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "format-response",
      "name": "Format Response",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [2020, 260]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "respond-webhook",
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [2240, 260]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "knowledge/store",
        "responseMode": "responseNode",
        "options": {
          "responseCode": 200
        }
      },
      "id": "knowledge-webhook",
      "name": "Knowledge Storage Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [260, 700],
      "webhookId": "knowledge-store-webhook"
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{$json.documents}}",
              "operation": "isNotEmpty"
            }
          ]
        }
      },
      "id": "validate-documents",
      "name": "Validate Documents",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [480, 700]
    },
    {
      "parameters": {
        "fieldToSplitOut": "documents",
        "options": {}
      },
      "id": "split-documents",
      "name": "Split Documents",
      "type": "n8n-nodes-base.itemLists",
      "typeVersion": 3,
      "position": [700, 620]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "title",
              "name": "title",
              "value": "={{$json.title}}",
              "type": "string"
            },
            {
              "id": "content",
              "name": "content",
              "value": "={{$json.content}}",
              "type": "string"
            },
            {
              "id": "category",
              "name": "category",
              "value": "={{$json.category || 'general'}}",
              "type": "string"
            },
            {
              "id": "metadata",
              "name": "metadata",
              "value": "={{$json.metadata || {}}}",
              "type": "json"
            }
          ]
        },
        "options": {}
      },
      "id": "prepare-document",
      "name": "Prepare Document",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [920, 620]
    },
    {
      "parameters": {
        "operation": "load",
        "tableId": "knowledge_base",
        "documentColumn": "content",
        "metadataColumns": ["title", "category"]
      },
      "id": "store-in-vector",
      "name": "Store in Vector DB",
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1,
      "position": [1140, 620],
      "credentials": {
        "supabaseApi": {
          "id": "supabase-credentials",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "model": "text-embedding-3-small",
        "options": {}
      },
      "id": "embedding-openai",
      "name": "OpenAI Embeddings",
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1,
      "position": [1140, 760],
      "credentials": {
        "openAiApi": {
          "id": "openai-credentials",
          "name": "OpenAI API"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "message",
              "name": "message",
              "value": "ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ­£å¸¸ã«ä¿å­˜ã—ã¾ã—ãŸ",
              "type": "string"
            },
            {
              "id": "status",
              "name": "status",
              "value": "success",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "format-storage-response",
      "name": "Format Storage Response",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [1360, 620]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "respond-storage",
      "name": "Respond Storage Success",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1580, 620]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "error-message",
              "name": "error",
              "value": "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒç©ºã§ã™",
              "type": "string"
            },
            {
              "id": "status",
              "name": "status",
              "value": "error",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "validation-error",
      "name": "Validation Error",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [700, 420]
    },
    {
      "parameters": {
        "options": {
          "responseCode": 400
        }
      },
      "id": "validation-error-response",
      "name": "Validation Error Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [920, 420]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "error-message",
              "name": "error",
              "value": "ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒç©ºã§ã™",
              "type": "string"
            },
            {
              "id": "status",
              "name": "status",
              "value": "error",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "doc-validation-error",
      "name": "Document Validation Error",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [700, 780]
    },
    {
      "parameters": {
        "options": {
          "responseCode": 400
        }
      },
      "id": "doc-error-response",
      "name": "Document Error Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [920, 780]
    },
    {
      "parameters": {
        "content": "## ğŸ¯ Phase 4 - RAGå®Ÿè£…\n\n### ä¸»è¦æ©Ÿèƒ½:\n1. **ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢**\n   - Supabase Vector Storeä½¿ç”¨\n   - OpenAI Embeddings (1536æ¬¡å…ƒ)\n   - é¡ä¼¼åº¦æ¤œç´¢\n\n2. **RAGã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ§‹ç¯‰**\n   - ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹æ¤œç´¢\n   - ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆçµåˆ\n   - AI Agentã¸ã®çµ±åˆ\n\n3. **ãƒŠãƒ¬ãƒƒã‚¸ç®¡ç†**\n   - ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç™»éŒ²\n   - è‡ªå‹•Embeddingç”Ÿæˆ\n   - Vector DBã¸ã®ä¿å­˜\n\n### ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ:\n- POST /chatbot/rag\n- POST /knowledge/store\n\n### ä½¿ç”¨æ–¹æ³•:\n```json\n// RAGãƒãƒ£ãƒƒãƒˆ\n{\n  \"message\": \"è³ªå•å†…å®¹\",\n  \"sessionId\": \"xxx\",\n  \"topK\": 5\n}\n\n// ãƒŠãƒ¬ãƒƒã‚¸ç™»éŒ²\n{\n  \"documents\": [\n    {\n      \"title\": \"ã‚¿ã‚¤ãƒˆãƒ«\",\n      \"content\": \"å†…å®¹\",\n      \"category\": \"ã‚«ãƒ†ã‚´ãƒª\"\n    }\n  ]\n}\n```",
        "height": 520,
        "width": 400
      },
      "id": "rag-note",
      "name": "RAG Implementation Note",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [180, 900]
    }
  ],
  "connections": {
    "Webhook Trigger": {
      "main": [
        [
          {
            "node": "Input Validation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Input Validation": {
      "main": [
        [
          {
            "node": "Extract Query",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Validation Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Query": {
      "main": [
        [
          {
            "node": "Generate Embedding",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Embedding": {
      "main": [
        [
          {
            "node": "Build RAG Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Vector Store Retriever": {
      "ai_retriever": [
        [
          {
            "node": "AI Agent with RAG",
            "type": "ai_retriever",
            "index": 0
          }
        ]
      ]
    },
    "Supabase Vector Store": {
      "ai_vectorStore": [
        [
          {
            "node": "Vector Store Retriever",
            "type": "ai_vectorStore",
            "index": 0
          }
        ]
      ]
    },
    "Build RAG Context": {
      "main": [
        [
          {
            "node": "AI Agent with RAG",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent with RAG": {
      "main": [
        [
          {
            "node": "Save Conversation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent with RAG",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Memory Buffer": {
      "ai_memory": [
        [
          {
            "node": "AI Agent with RAG",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Save Conversation": {
      "main": [
        [
          {
            "node": "Format Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Response": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Knowledge Storage Webhook": {
      "main": [
        [
          {
            "node": "Validate Documents",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate Documents": {
      "main": [
        [
          {
            "node": "Split Documents",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Document Validation Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Documents": {
      "main": [
        [
          {
            "node": "Prepare Document",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Document": {
      "main": [
        [
          {
            "node": "Store in Vector DB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Embeddings": {
      "ai_embedding": [
        [
          {
            "node": "Store in Vector DB",
            "type": "ai_embedding",
            "index": 0
          },
          {
            "node": "Supabase Vector Store",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Store in Vector DB": {
      "main": [
        [
          {
            "node": "Format Storage Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Storage Response": {
      "main": [
        [
          {
            "node": "Respond Storage Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validation Error": {
      "main": [
        [
          {
            "node": "Validation Error Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Document Validation Error": {
      "main": [
        [
          {
            "node": "Document Error Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "saveExecutionProgress": true,
    "saveDataSuccessExecution": "all",
    "saveDataErrorExecution": "all",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": "",
    "timezone": "Asia/Tokyo"
  },
  "versionId": "phase-4-rag-fixed",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "intelligent-learning-chatbot-phase4-rag",
    "description": "Phase 4: RAG implementation with Supabase vector store"
  },
  "id": "intelligent-learning-chatbot-phase4-rag",
  "tags": [
    {
      "id": "chatbot",
      "name": "Chatbot"
    },
    {
      "id": "ai",
      "name": "AI"
    },
    {
      "id": "phase4",
      "name": "Phase 4"
    },
    {
      "id": "rag",
      "name": "RAG"
    },
    {
      "id": "vector-search",
      "name": "Vector Search"
    }
  ]
}